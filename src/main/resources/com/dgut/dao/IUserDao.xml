<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 命名空间表示对应的java接口 -->
<mapper namespace="com.dgut.dao.IUserDao">

    <sql id="defaultSql">
        select * from user
    </sql>

    <resultMap id="user_account_Map" type="user">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="address" property="address"/>
        <!--1对多的映射
        ofType: 集合里面放的数据类型-->
        <collection property="accounts" ofType="com.dgut.domain.Account">
            <id column="account_id" property="id"/>
            <result column="money" property="money"/>
        </collection>
    </resultMap>

    <!--select：查询
           id：对应接口的方法名
           resultType：返回的结合里面包含的数据类型-->
    <select id="findAllUser" resultMap="user_account_Map">
        <!-- <include refid="defaultSql"></include>-->
        SELECT user.*,account.ID AS account_id,account.MONEY as MONEY FROM `user` LEFT JOIN account ON `user`.id =
        account.UID
    </select>


    <!--sql中的？用#{}表示 -->
    <select id="findUserByID" resultType="com.dgut.domain.User">
        select * from user where id = #{id}

    </select>


    <!--#{username}表示调用parameterType（User）里面的getUsername()-->
    <!--    <insert id="inserUser">-->
    <!--        insert into user(username,address) VALUES(#{username},#{address})-->
    <!--        <selectKey keyColumn="id" keyProperty="id" resultType="int">-->
    <!--            select LAST_INSERT_ID()-->
    <!--        </selectKey>-->
    <!--    </insert>-->
    <insert id="inserUser" keyColumn="id" keyProperty="id" useGeneratedKeys="false">
             insert into user(username,address) VALUES(#{username},#{address})
   </insert>


    <update id="updateUser" parameterType="com.dgut.domain.User">
        update user set username=#{username},address=#{address} where id = #{id}
    </update>

    <delete id="deleteUser">
        DELETE FROM user where ID = #{id}
    </delete>


    <select id="findByName" parameterType="string" resultType="com.dgut.domain.User">
        select * from user where username like #{username}
    </select>


    <!-- ${value}:直接把我们传过来的参数替换 -->
    <select id="findByName2" resultType="com.dgut.domain.User">
        select * from user where username like '%${value}%'
    </select>

    <select id="findTotal" resultType="int">
        select count(*) from user
    </select>

    <select id="findByNameAndSex" resultType="com.dgut.domain.User">
        select * from user where username like #{param1} and sex = #{arg1}
    </select>


    <select id="findByNameAndSex2" parameterType="com.dgut.queryVO.UserVo" resultType="com.dgut.domain.User">
        select * from user where username like #{username} and sex = #{sex}
    </select>


    <select id="findByUser" parameterType="user" resultType="user">
        select * from user
        <where>
            <if test="id!=null">
                and id = #{id}
            </if>

            <if test="username!=null">
                and username=#{username}
            </if>
        </where>
    </select>

    <!-- id IN (45,46,48)-->
    <!--id IN (-->
    <!--45,46,48-->
    <!--)-->
    <select id="findByQvo" resultType="user">
        SELECT * FROM USER
        <where>
            <if test="username!=null">
                and username LIKE #{username}
            </if>

            <if test="ids!=null and ids.size()>0">
                AND
                <foreach collection="ids" item="abc" open=" id IN (" close=")" separator=",">
                    #{abc}
                </foreach>
            </if>
        </where>
    </select>

    <resultMap id="user_role_Map" type="user">
        <id column="id" property="id"></id>
        <result column="username" property="username"/>
        <result column="address" property="address"/>
        <collection property="roles" ofType="role">
            <result column="role_name" property="roleName"/>
            <result column="role_desc" property="roleDesc"/>
        </collection>
    </resultMap>

    <select id="findUsersWithRoles"  resultMap="user_role_Map">
        select * FROM `user` LEFT JOIN user_role ON `user`.id = user_role.UID LEFT JOIN role on RID = role.ID
    </select>


    <resultMap id="users_account_Map" type="user">
        <id column="id" property="id"></id>
        <result column="username" property="username"/>
        <result column="address" property="address"/>
        <collection property="accounts" select="com.dgut.dao.IAccountDao.findByUid" column="id">

        </collection>
    </resultMap>

    <select id="findUsersWithAccounts2" resultMap="users_account_Map">
        select * from user
    </select>
</mapper>